<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Portfolio Management</title>
  <link rel="icon" href="./assets/favicon1.png" type="image/png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { padding-top: 20px; }
    .admin-section { margin-bottom: 40px; }
    .item-card { margin-bottom: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
    .login-container { max-width: 400px; margin: 100px auto; }
  </style>
</head>
<body class="bg-light">
  <div id="loginSection" class="login-container">
    <div class="card">
      <div class="card-body">
        <h2 class="text-center mb-4">Admin Login</h2>
        <form id="loginForm">
          <div class="mb-3">
            <label for="password" class="form-label">Admin Password</label>
            <input type="password" class="form-control" id="password" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
      </div>
    </div>
  </div>

  <div id="adminPanel" style="display: none;">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Portfolio Admin Panel</h1>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>

      <div class="admin-section">
        <h2>Manage Projects</h2>
        <button class="btn btn-success mb-3" onclick="showAddProjectForm()">
          <i class="bi bi-plus-circle"></i> Add New Project
        </button>
        
        <div id="addProjectForm" class="card mb-3" style="display: none;">
          <div class="card-body">
            <h5>Add New Project</h5>
            <form id="projectForm">
              <div class="mb-3">
                <label class="form-label">Project Title</label>
                <input type="text" class="form-control" id="projectTitle" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Image</label>
                <div class="mb-2">
                  <input type="radio" name="projectImageType" id="projectImageUrl" value="url" checked>
                  <label for="projectImageUrl">Image URL</label>
                  <input type="radio" name="projectImageType" id="projectImageFile" value="file" class="ms-3">
                  <label for="projectImageFile">Upload Image</label>
                </div>
                <input type="url" class="form-control" id="projectImage">
                <input type="file" class="form-control" id="projectImageUpload" accept="image/*" style="display: none;">
                <div id="projectImagePreview" class="mt-2"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="projectDescription" required></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Website URL</label>
                <input type="url" class="form-control" id="projectWebsite" required>
              </div>
              <div class="mb-3">
                <label class="form-label">GitHub URL</label>
                <input type="url" class="form-control" id="projectGithub" required>
              </div>
              <button type="submit" class="btn btn-primary">Add Project</button>
              <button type="button" class="btn btn-secondary" onclick="hideAddProjectForm()">Cancel</button>
            </form>
          </div>
        </div>

        <div id="projectsList"></div>
      </div>

      <div class="admin-section">
        <h2>Manage Certificates</h2>
        <button class="btn btn-success mb-3" onclick="showAddCertificateForm()">
          <i class="bi bi-plus-circle"></i> Add New Certificate
        </button>
        
        <div id="addCertificateForm" class="card mb-3" style="display: none;">
          <div class="card-body">
            <h5>Add New Certificate</h5>
            <form id="certificateForm">
              <div class="mb-3">
                <label class="form-label">Certificate Title</label>
                <input type="text" class="form-control" id="certificateTitle" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Image</label>
                <div class="mb-2">
                  <input type="radio" name="certificateImageType" id="certificateImageUrl" value="url" checked>
                  <label for="certificateImageUrl">Image URL</label>
                  <input type="radio" name="certificateImageType" id="certificateImageFile" value="file" class="ms-3">
                  <label for="certificateImageFile">Upload Image</label>
                </div>
                <input type="url" class="form-control" id="certificateImage">
                <input type="file" class="form-control" id="certificateImageUpload" accept="image/*" style="display: none;">
                <div id="certificateImagePreview" class="mt-2"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Certificate URL (optional)</label>
                <input type="url" class="form-control" id="certificateUrl">
              </div>
              <div class="mb-3">
                <label class="form-label">Issuer</label>
                <input type="text" class="form-control" id="certificateIssuer" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Issuer URL</label>
                <input type="url" class="form-control" id="certificateIssuerUrl" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Issue Date</label>
                <input type="text" class="form-control" id="certificateDate" placeholder="e.g., April, 07 2025" required>
              </div>
              <button type="submit" class="btn btn-primary">Add Certificate</button>
              <button type="button" class="btn btn-secondary" onclick="hideAddCertificateForm()">Cancel</button>
            </form>
          </div>
        </div>

        <div id="certificatesList"></div>
      </div>
    </div>
  </div>

  <script>
    let adminToken = localStorage.getItem('adminToken');

    if (adminToken) {
      showAdminPanel();
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      adminToken = password;
      localStorage.setItem('adminToken', adminToken);
      
      const valid = await testAuth();
      if (valid) {
        showAdminPanel();
      } else {
        document.getElementById('loginError').textContent = 'Invalid password';
        document.getElementById('loginError').style.display = 'block';
        localStorage.removeItem('adminToken');
        adminToken = null;
      }
    });

    async function testAuth() {
      try {
        const response = await fetch('/api/projects', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        return response.ok;
      } catch {
        return false;
      }
    }

    function showAdminPanel() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      loadProjects();
      loadCertificates();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      location.reload();
    }

    function showAddProjectForm() {
      document.getElementById('addProjectForm').style.display = 'block';
    }

    function hideAddProjectForm() {
      document.getElementById('addProjectForm').style.display = 'none';
      document.getElementById('projectForm').reset();
      delete document.getElementById('projectForm').dataset.editId;
      document.getElementById('addProjectForm').querySelector('h5').textContent = 'Add New Project';
      document.getElementById('projectForm').querySelector('button[type="submit"]').textContent = 'Add Project';
    }

    function showAddCertificateForm() {
      document.getElementById('addCertificateForm').style.display = 'block';
    }

    function hideAddCertificateForm() {
      document.getElementById('addCertificateForm').style.display = 'none';
      document.getElementById('certificateForm').reset();
      delete document.getElementById('certificateForm').dataset.editId;
      document.getElementById('addCertificateForm').querySelector('h5').textContent = 'Add New Certificate';
      document.getElementById('certificateForm').querySelector('button[type="submit"]').textContent = 'Add Certificate';
    }

    document.querySelectorAll('input[name="projectImageType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const isUrl = e.target.value === 'url';
        document.getElementById('projectImage').style.display = isUrl ? 'block' : 'none';
        document.getElementById('projectImageUpload').style.display = isUrl ? 'none' : 'block';
        if (isUrl) {
          document.getElementById('projectImage').required = true;
          document.getElementById('projectImageUpload').required = false;
        } else {
          document.getElementById('projectImage').required = false;
          document.getElementById('projectImageUpload').required = true;
        }
      });
    });

    document.querySelectorAll('input[name="certificateImageType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const isUrl = e.target.value === 'url';
        document.getElementById('certificateImage').style.display = isUrl ? 'block' : 'none';
        document.getElementById('certificateImageUpload').style.display = isUrl ? 'none' : 'block';
        if (isUrl) {
          document.getElementById('certificateImage').required = true;
          document.getElementById('certificateImageUpload').required = false;
        } else {
          document.getElementById('certificateImage').required = false;
          document.getElementById('certificateImageUpload').required = true;
        }
      });
    });

    document.getElementById('projectImageUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('projectImagePreview').innerHTML = 
            `<img src="${e.target.result}" class="img-fluid" style="max-height: 150px;" alt="Preview">`;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('certificateImageUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('certificateImagePreview').innerHTML = 
            `<img src="${e.target.result}" class="img-fluid" style="max-height: 150px;" alt="Preview">`;
        };
        reader.readAsDataURL(file);
      }
    });

    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${adminToken}`
        },
        body: formData
      });
      
      if (!response.ok) {
        throw new Error('Failed to upload image');
      }
      
      const data = await response.json();
      return data.url;
    }

    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      let imageUrl = document.getElementById('projectImage').value;
      const imageType = document.querySelector('input[name="projectImageType"]:checked').value;
      
      if (imageType === 'file') {
        const file = document.getElementById('projectImageUpload').files[0];
        if (file) {
          imageUrl = await uploadImage(file);
        }
      }
      
      const project = {
        title: document.getElementById('projectTitle').value,
        image: imageUrl,
        description: document.getElementById('projectDescription').value,
        website: document.getElementById('projectWebsite').value,
        github: document.getElementById('projectGithub').value
      };

      const editId = document.getElementById('projectForm').dataset.editId;
      if (editId) {
        project.id = editId;
      }

      try {
        const response = await fetch('/api/projects', {
          method: editId ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify(project)
        });

        if (response.ok) {
          hideAddProjectForm();
          loadProjects();
        } else {
          alert('Failed to save project');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    document.getElementById('certificateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      let imageUrl = document.getElementById('certificateImage').value;
      const imageType = document.querySelector('input[name="certificateImageType"]:checked').value;
      
      if (imageType === 'file') {
        const file = document.getElementById('certificateImageUpload').files[0];
        if (file) {
          imageUrl = await uploadImage(file);
        }
      }
      
      const certificate = {
        title: document.getElementById('certificateTitle').value,
        image: imageUrl,
        url: document.getElementById('certificateUrl').value,
        issuer: document.getElementById('certificateIssuer').value,
        issuerUrl: document.getElementById('certificateIssuerUrl').value,
        date: document.getElementById('certificateDate').value
      };

      const editId = document.getElementById('certificateForm').dataset.editId;
      if (editId) {
        certificate.id = editId;
      }

      try {
        const response = await fetch('/api/certificates', {
          method: editId ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify(certificate)
        });

        if (response.ok) {
          hideAddCertificateForm();
          loadCertificates();
        } else {
          alert('Failed to save certificate');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    async function loadProjects() {
      try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        const projectsList = document.getElementById('projectsList');
        projectsList.innerHTML = projects.map(project => `
          <div class="item-card">
            <div class="row">
              <div class="col-md-2">
                <img src="${project.image}" class="img-fluid" alt="${project.title}">
              </div>
              <div class="col-md-8">
                <h5>${project.title}</h5>
                <p>${project.description}</p>
                <a href="${project.website}" target="_blank">Website</a> | 
                <a href="${project.github}" target="_blank">GitHub</a>
              </div>
              <div class="col-md-2 text-end">
                <button class="btn btn-primary btn-sm mb-2" onclick="editProject('${project.id}')">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteProject('${project.id}')">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading projects:', error);
      }
    }

    async function loadCertificates() {
      try {
        const response = await fetch('/api/certificates');
        const certificates = await response.json();
        
        const certificatesList = document.getElementById('certificatesList');
        certificatesList.innerHTML = certificates.map(cert => `
          <div class="item-card">
            <div class="row">
              <div class="col-md-2">
                <img src="${cert.image}" class="img-fluid" alt="${cert.title}">
              </div>
              <div class="col-md-8">
                <h5>${cert.title}</h5>
                <p>Issued by <a href="${cert.issuerUrl}" target="_blank">${cert.issuer}</a> on ${cert.date}</p>
                ${cert.url ? `<a href="${cert.url}" target="_blank">View Certificate</a>` : ''}
              </div>
              <div class="col-md-2 text-end">
                <button class="btn btn-primary btn-sm mb-2" onclick="editCertificate('${cert.id}')">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteCertificate('${cert.id}')">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading certificates:', error);
      }
    }

    async function deleteProject(id) {
      if (!confirm('Are you sure you want to delete this project?')) return;
      
      try {
        const response = await fetch(`/api/projects?id=${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${adminToken}`
          }
        });

        if (response.ok) {
          loadProjects();
        } else {
          alert('Failed to delete project');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function deleteCertificate(id) {
      if (!confirm('Are you sure you want to delete this certificate?')) return;
      
      try {
        const response = await fetch(`/api/certificates?id=${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${adminToken}`
          }
        });

        if (response.ok) {
          loadCertificates();
        } else {
          alert('Failed to delete certificate');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function editProject(id) {
      try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        const project = projects.find(p => p.id === id);
        
        if (!project) {
          alert('Project not found');
          return;
        }
        
        document.getElementById('projectTitle').value = project.title;
        document.getElementById('projectImage').value = project.image;
        document.getElementById('projectDescription').value = project.description;
        document.getElementById('projectWebsite').value = project.website;
        document.getElementById('projectGithub').value = project.github;
        
        document.getElementById('projectForm').dataset.editId = id;
        document.getElementById('addProjectForm').querySelector('h5').textContent = 'Edit Project';
        document.getElementById('projectForm').querySelector('button[type="submit"]').textContent = 'Update Project';
        
        document.getElementById('addProjectForm').style.display = 'block';
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function editCertificate(id) {
      try {
        const response = await fetch('/api/certificates');
        const certificates = await response.json();
        const cert = certificates.find(c => c.id === id);
        
        if (!cert) {
          alert('Certificate not found');
          return;
        }
        
        document.getElementById('certificateTitle').value = cert.title;
        document.getElementById('certificateImage').value = cert.image;
        document.getElementById('certificateUrl').value = cert.url || '';
        document.getElementById('certificateIssuer').value = cert.issuer;
        document.getElementById('certificateIssuerUrl').value = cert.issuerUrl;
        document.getElementById('certificateDate').value = cert.date;
        
        document.getElementById('certificateForm').dataset.editId = id;
        document.getElementById('addCertificateForm').querySelector('h5').textContent = 'Edit Certificate';
        document.getElementById('certificateForm').querySelector('button[type="submit"]').textContent = 'Update Certificate';
        
        document.getElementById('addCertificateForm').style.display = 'block';
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
  </script>
</body>
</html>
